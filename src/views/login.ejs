<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NudeAdmin - Login</title>
  <link rel="stylesheet" href="/assets/theme.css" />
  <link rel="stylesheet" href="/static/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script defer src="/shared/client/toast.js"></script>
  <script defer src="/shared/client/auth-modal.js"></script>
</head>
<body style="margin:0;">
  <div id="toast-root" class="toast-root" aria-live="polite" aria-atomic="false"></div>
  <!-- Auth overlay markup (signup disabled in admin) -->
  <div id="authOverlay" class="auth-overlay" role="dialog" aria-modal="true" aria-labelledby="authTitle" hidden>
    <div id="authModal" class="auth-modal" role="document">
      <!-- Close button intentionally removed for admin bootstrap/login lockdown -->
      <div class="auth-header">
        <h2 id="authTitle" class="auth-title">Admin Login</h2>
      </div>
      <div class="auth-body">
  <form id="authLoginPanel" class="auth-form" role="tabpanel" aria-labelledby="authTitle">
          <div class="auth-field">
            <label for="loginEmail">Email or Username</label>
            <input id="loginEmail" type="text" class="auth-input" placeholder="admin@example.com or admin" autocomplete="username">
          </div>
          <div class="auth-field">
            <label for="loginPassword">Password</label>
            <input id="loginPassword" type="password" class="auth-input" placeholder="••••••••" autocomplete="current-password">
          </div>
          <div class="auth-actions">
            <button type="button" class="btn-success-solid auth-submit" data-mode="login">Log in</button>
          </div>
        </form>
  <form id="authSignupPanel" class="auth-form" role="tabpanel" aria-labelledby="authTitle" hidden>
          <div class="auth-field">
            <label for="signupEmail">Email</label>
            <input id="signupEmail" type="email" class="auth-input" placeholder="admin@example.com" autocomplete="email">
          </div>
          <div class="auth-field">
            <label for="signupUsername">Username</label>
            <input id="signupUsername" type="text" class="auth-input" placeholder="admin" autocomplete="username">
          </div>
          <div class="auth-field">
            <label for="signupPassword">Password
              <span aria-label="Password strength tips" title="Fair: 10+ characters, mix upper/lowercase, a number and a symbol. Strong: 14+ with variety." style="margin-left:.35rem; cursor:help; font-size:.85em; color:var(--color-text-dim);">ⓘ</span>
            </label>
            <input id="signupPassword" type="password" class="auth-input" placeholder="Create password (min 6)" autocomplete="new-password">
          </div>
            <div class="auth-field">
              <label for="signupConfirm">Repeat password</label>
              <input id="signupConfirm" type="password" class="auth-input" placeholder="Repeat password" autocomplete="new-password">
              <small id="signupConfirmError" style="color:#e53935; display:none;">Passwords do not match</small>
            </div>
          <div class="auth-field password-strength" aria-live="polite">
            <div class="pw-meter" id="signupPwMeter" data-score="0">
              <span class="pw-bar"></span>
            </div>
            <small id="signupPwFeedback" class="pw-feedback text-dim">Enter a password</small>
          </div>
          <div class="auth-actions">
            <button type="button" class="btn-info auth-submit" data-mode="signup" disabled>Create admin</button>
          </div>
          <p class="text-dim" style="margin:.5rem 0 0 .15rem; font-size:.6rem;">First account will be granted admin role automatically.</p>
        </form>
      </div>
      <div class="auth-switch">
        <button type="button" id="authSwitch" class="linklike" style="background:none;border:none;color:var(--color-accent);cursor:pointer;padding:.25rem .15rem;">Don't have an account? Sign up</button>
      </div>
      <p class="auth-note text-dim" style="margin:.5rem 0 0 .25rem; font-size:.65rem;">Sign up disabled for admin panel.</p>
    </div>
  </div>
  <script>
  (function(){
    function openLogin(){
      const opener = document.getElementById('authOpenBtn');
      if(opener) opener.click();
    }
    // Inject minimal button for auth-modal.js expectations
    const btn=document.createElement('button');
    btn.id='authOpenBtn';
    btn.type='button';
    btn.style.display='none';
    document.body.appendChild(btn);
    // Observe login success via polling /auth/me after auth-modal sets local flag
    const CHECK_INTERVAL=2500;
    let fallbackTimer;
    function fallbackCheck(){
      fetch('/auth/me').then(r=>r.json().catch(()=>({}))).then(j=>{
        if(j && j.user){ window.location.replace('/dashboard'); }
        else fallbackTimer = setTimeout(fallbackCheck, CHECK_INTERVAL);
      }).catch(()=> fallbackTimer = setTimeout(fallbackCheck, CHECK_INTERVAL));
    }
    window.addEventListener('auth:login-success', ()=>{ window.location.replace('/dashboard'); });

    // Bootstrap check: if no admin exists enable signup panel and show switch; else hide switch
    fetch('/auth/bootstrap/admin-needed').then(r=>r.json().catch(()=>({}))).then(j=>{
      const signupPanel=document.getElementById('authSignupPanel');
      const loginPanel=document.getElementById('authLoginPanel');
      const note=document.querySelector('.auth-note');
      const switchBtn=document.getElementById('authSwitch');
      const modalEl = document.getElementById('authModal');
      if(j && j.adminNeeded){
        if(modalEl) modalEl.setAttribute('data-admin-bootstrap','');
        try{ localStorage.setItem('authLastTab','1'); }catch(_){ }
        // Enable signup only, hide login panel and auto-open signup
        if(signupPanel){ signupPanel.hidden=false; signupPanel.setAttribute('aria-hidden','false'); }
        if(loginPanel){ loginPanel.hidden=true; }
        if(note) note.textContent='Create the first admin account (required).';
        if(switchBtn){ switchBtn.style.display='none'; }
        document.getElementById('signupEmail')?.focus();
      } else {
        if(modalEl) modalEl.removeAttribute('data-admin-bootstrap');
        // Normal login only (signup removed) once an admin exists
        if(signupPanel) signupPanel.remove();
        if(note) note.textContent='Sign up disabled for admin panel.';
        if(switchBtn){ switchBtn.style.display='none'; }
        document.getElementById('loginEmail')?.focus();
      }
      openLogin();
      fallbackCheck();
    }).catch(()=>{ openLogin(); fallbackCheck(); });
  })();
  </script>
</body>
</html>
